# Data_modeling_with_postgresql
![image](https://user-images.githubusercontent.com/99410373/156909224-8d94540f-4c4a-4a98-9918-536494c365ab.png)

## Prerequisites
- Knowledge about Python and SQL
- This project requires Postgresql database, so please make sure to install Postgresql program (including psql and pgAdmin 4)
## Introduction
A startup called Sparkify wants to analyze the data they have been collecting on songs and user activity on their new music streaming app. The analytics team is particularly interested in understanding what songs users are listening to. Currently, they do not have an easy way to query the data, which resides in a directory of JSON logs on user activity on the app, as well as a directory with JSON metadata on the songs in their app.

It is **required to a PostgresSQL database** with tables designed to optimize queries on song play analysis **creating a database schema and ETL pipeline for this analysis**.

The database and ETL process are requited to be tested by running given queries by the analytics team from Sparkify and comparing the outputs with the expected results.

_(This is a small project in the 'Data Engineer' course of Udacity)._
## Project Description
The project is applied knowledge of data modeling with PostgreSQL and ETL pipeline using Python. **Fact and Dimension tables are designed in a star schema** for a particular analytic focus, and the ETL pipeline transfers data from files in two local directories into the mentioned tables in PostgreSQL using Python and SQL.
## Project Development
### Dataset
#### Song dataset
The songs' metadata sourse is a subset of the Million Song Dataset. Each file is in JSON format and contains metadata about a song and the artist of that song
```python
{"num_songs": 1, "artist_id": "ARD7TVE1187B99BFB1", "artist_latitude": null, "artist_longitude": null, "artist_location": "California - LA", "artist_name": "Casual", "song_id": "SOMZWCG12A8C13C480", "title": "I Didn't Mean To", "duration": 218.93179, "year": 0}
```
#### Log dataset
Consists of log files in JSON format generated by this event simulator based on the songs in the dataset songs.
```python
{"artist":null,"auth":"Logged In","firstName":"Walter","gender":"M","itemInSession":0,"lastName":"Frye","length":null,"level":"free","location":"San Francisco-Oakland-Hayward, CA","method":"GET","page":"Home","registration":1540919166796.0,"sessionId":38,"song":null,"status":200,"ts":1541105830796,"userAgent":"\"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/36.0.1985.143 Safari\/537.36\"","userId":"39"}
{"artist":null,"auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":0,"lastName":"Summers","length":null,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"GET","page":"Home","registration":1540344794796.0,"sessionId":139,"song":null,"status":200,"ts":1541106106796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Des'ree","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":1,"lastName":"Summers","length":246.30812,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"You Gotta Be","status":200,"ts":1541106106796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":null,"auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":2,"lastName":"Summers","length":null,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"GET","page":"Upgrade","registration":1540344794796.0,"sessionId":139,"song":null,"status":200,"ts":1541106132796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Mr Oizo","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":3,"lastName":"Summers","length":144.03873,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"Flat 55","status":200,"ts":1541106352796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Tamba Trio","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":4,"lastName":"Summers","length":177.18812,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"Quem Quiser Encontrar O Amor","status":200,"ts":1541106496796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"The Mars Volta","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":5,"lastName":"Summers","length":380.42077,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"Eriatarka","status":200,"ts":1541106673796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Infected Mushroom","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":6,"lastName":"Summers","length":440.2673,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"Becoming Insane","status":200,"ts":1541107053796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Blue October \/ Imogen Heap","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":7,"lastName":"Summers","length":241.3971,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"Congratulations","status":200,"ts":1541107493796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Girl Talk","auth":"Logged In","firstName":"Kaylee","gender":"F","itemInSession":8,"lastName":"Summers","length":160.15628,"level":"free","location":"Phoenix-Mesa-Scottsdale, AZ","method":"PUT","page":"NextSong","registration":1540344794796.0,"sessionId":139,"song":"Once again","status":200,"ts":1541107734796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/35.0.1916.153 Safari\/537.36\"","userId":"8"}
{"artist":"Black Eyed Peas","auth":"Logged In","firstName":"Sylvie","gender":"F","itemInSession":0,"lastName":"Cruz","length":214.93506,"level":"free","location":"Washington-Arlington-Alexandria, DC-VA-MD-WV","method":"PUT","page":"NextSong","registration":1540266185796.0,"sessionId":9,"song":"Pump It","status":200,"ts":1541108520796,"userAgent":"\"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_9_4) AppleWebKit\/537.77.4 (KHTML, like Gecko) Version\/7.0.5 Safari\/537.77.4\"","userId":"10"}
{"artist":null,"auth":"Logged In","firstName":"Ryan","gender":"M","itemInSession":0,"lastName":"Smith","length":null,"level":"free","location":"San Jose-Sunnyvale-Santa Clara, CA","method":"GET","page":"Home","registration":1541016707796.0,"sessionId":169,"song":null,"status":200,"ts":1541109015796,"userAgent":"\"Mozilla\/5.0 (X11; Linux x86_64) AppleWebKit\/537.36 (KHTML, like Gecko) Ubuntu Chromium\/36.0.1985.125 Chrome\/36.0.1985.125 Safari\/537.36\"","userId":"26"}
{"artist":"Fall Out Boy","auth":"Logged In","firstName":"Ryan","gender":"M","itemInSession":1,"lastName":"Smith","length":200.72444,"level":"free","location":"San Jose-Sunnyvale-Santa Clara, CA","method":"PUT","page":"NextSong","registration":1541016707796.0,"sessionId":169,"song":"Nobody Puts Baby In The Corner","status":200,"ts":1541109125796,"userAgent":"\"Mozilla\/5.0 (X11; Linux x86_64) AppleWebKit\/537.36 (KHTML, like Gecko) Ubuntu Chromium\/36.0.1985.125 Chrome\/36.0.1985.125 Safari\/537.36\"","userId":"26"}
{"artist":"M.I.A.","auth":"Logged In","firstName":"Ryan","gender":"M","itemInSession":2,"lastName":"Smith","length":233.7171,"level":"free","location":"San Jose-Sunnyvale-Santa Clara, CA","method":"PUT","page":"NextSong","registration":1541016707796.0,"sessionId":169,"song":"Mango Pickle Down River (With The Wilcannia Mob)","status":200,"ts":1541109325796,"userAgent":"\"Mozilla\/5.0 (X11; Linux x86_64) AppleWebKit\/537.36 (KHTML, like Gecko) Ubuntu Chromium\/36.0.1985.125 Chrome\/36.0.1985.125 Safari\/537.36\"","userId":"26"}
{"artist":"Survivor","auth":"Logged In","firstName":"Jayden","gender":"M","itemInSession":0,"lastName":"Fox","length":245.36771,"level":"free","location":"New Orleans-Metairie, LA","method":"PUT","page":"NextSong","registration":1541033612796.0,"sessionId":100,"song":"Eye Of The Tiger","status":200,"ts":1541110994796,"userAgent":"\"Mozilla\/5.0 (Windows NT 6.3; WOW64) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/36.0.1985.143 Safari\/537.36\"","userId":"101"}
```
#### Star Schemma (ERD)
We'll build the database by optimizing the tables around efficient reads for complex queries. To do that, Star schema will be used utilizing dimensional modeling as follows:

- Fact table: song_play

- Dimensions tables: song, artist, users, datetime.
![image](https://user-images.githubusercontent.com/99410373/156907071-2670aa66-d773-476f-a7c0-77df53ab65b9.png)


### Local database setup 
1. After installing postgresql program, we need to create a new role in SQL Shell (psql).
2. Open SQL Shell (psql) and type as below:(in my case, I create role called 'admin')
``` bash
CREATE ROLE admin WITH LOGIN ENCRYPTED PASSWORD '<password>';
```
3. Assign permissions to the role created:
``` bash
ALTER ROLE admin CREATEDB;
```
4. Quit SQL Shell
``` bash
\q
```
5. Open SQL Shell again, acces the created role and create a new database. In my case, I already create a database called data_modeling_with_postgresql_01, I also show another example below

![image](https://user-images.githubusercontent.com/99410373/156907449-b933caa7-c007-4f26-823b-2ba1ec031fa0.png)

``` bash
CREATE DATABASE _<new_database>_;
```
### Development files
1. ```sql_queries.py ```: contain all sql queries
2. ```create_tables.py```: Drops and creates the tables. Running this file resets the tables before each time to run the ETL scripts (```etl.py```).
3. ```etl.py```: Reads and processes files from song_data and log_data and upload them into the tables
### Development environment 
This project is developed in **Pycharm**, use the corresponding Python version (Python v.3.9.7 64-bit). We can use ```python --version``` to check your current python version. This is important for installing suitable packages.
- Install some packages for this project:

```psycopg2```: Open your command prompt (for Window), in the current working directory, you type ```pip install psycopg2-binary``` (make sure ```pip``` command upgarde previously. Otherwise, you need to use ```python -m pip install --upgrade pip```. (The current pip command will be removed and its latest vesion will be installed).

```pandas, json, os, glob ```: These packages can be imported easily by Pycharm

## ETL pipeline
 Open **command prompt** (for Window), in the **current directory** root/relative_path/current_working_directory, q (or you can click 'run' buttun the execute the python script).

1. Firstly, we MUST run ```python create_tables.py``` to connect postgresql database.

2. Secondly, we continue to run ```python etl.py``` to do etl process.

## Output
After executing 2 python scripts, we will 5 tables. 
### artist
The "artist" table has **69 rows** inserted successfully.

![image](https://user-images.githubusercontent.com/99410373/156908593-3f607ecf-a364-42d1-8f62-295815e38cb6.png)

![image](https://user-images.githubusercontent.com/99410373/156908542-c2a47b45-90da-4a12-9333-0c181bc59a02.png)

### song
The "song" table has **71 rows** inserted successfully.

![image](https://user-images.githubusercontent.com/99410373/156908643-54e1d37d-c4bd-414f-81dc-956d36d91ac9.png)


![image](https://user-images.githubusercontent.com/99410373/156908633-33c5c304-bd82-44af-9389-66b31b4271f8.png)

### users
The "users" table has **96 rows** inserted successfully.

![image](https://user-images.githubusercontent.com/99410373/156908655-2351c4e2-1056-43fe-aa37-56d7b52e92f0.png)

![image](https://user-images.githubusercontent.com/99410373/156908674-de30bbb1-72f0-4c47-9cd5-9baa25d0d5a1.png)

### datetime
The "datetime" table has **6813 rows** inserted successfully.

![image](https://user-images.githubusercontent.com/99410373/156908691-8731160b-bab8-4469-9ee7-b9c836b7d613.png)

![image](https://user-images.githubusercontent.com/99410373/156908712-d5611984-6b1b-4619-a1a0-9e7ca2270bd6.png)
### song_play
The "song_play" FACT table has **6820 rows** inserted successfully.

![image](https://user-images.githubusercontent.com/99410373/156908745-e36400ef-e1c6-40bf-b060-6704c968fcb3.png)

![image](https://user-images.githubusercontent.com/99410373/156908784-638fdb58-55ce-435d-b229-685dffe37a0d.png)

### Testing
- To make sure 2 columns "song_id" and "aritist_id" inserted to the "song_play" table successfully and get values corresponding to "song_id" from song table" and "artist_id" from artist table, we need to check the result by using query below:

![image](https://user-images.githubusercontent.com/99410373/156908899-777e631d-8361-440c-9a7b-d6f9efa95b98.png)


